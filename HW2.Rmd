---
title: "HW2. Hypothesis testing"
output: html_document
---

# HW2. Тестирование гипотез. t-test. Доверительные интервалы. Корреляции 

Перед сдачей домашнего задания рекомендуем запустить Run All или сгенерировать html- или pdf-страницу с помощью Knit, чтобы убедиться, что в финальной версии весь ваш код будет запускаться без проблем.

Файл Rmd вы можете а) положить в свой приватный репозиторий da4clcourse на GitHub (в корне репозитория под именем HW1.Rmd). Дайте доступ преподавателю и ассистенту к приватному репозиторию (пригласите @olesar и @The-One-Who-Speaks-and-Depicts) или б) выслать преподавателю на почту olyashevskaya@hse.ru с темой da4clcourse.

## 1. Частотность и фонетика

В этом разделе используются те же данные, что и в прошлом домашнем задании. Вы можете пропустить описание, если знакомы с датасетом.  

Во многих лингвистических исследованиях отмечается, что часто используемые в языке слова звучат короче, а при их произнесении наблюдается редукция и коартикуляция. Работа Fabian Tomaschek et al. (2018) исследует гипотезу, что моторные навыки произнесения улучшаются с опытом, который, в свою очередь, напрямую связан с частотностью слова. Ученые попросили испытуемых (17 бакалавров университета Тюбингена, 8 мужчин и 9 женщин) прочитать вслух немецкие глаголы, содержащие звук [a:] в основе. Испытуемые были поставлены в экспериментальные условия, которые исподволь заставляли их читать быстрее или медленнее (slow/fast condition).

В этом задании мы просим вас сравнить длину звучания всего слова целиком, а также длину звучания интересующего ученых сегмента (звука [a:]) в условиях slow и fast. Хотя логично предположить, что в условии fast произнесение и слов, и сегментов будет короче, все же нужно убедиться, что данные это подтверждают, прежде чем переходить к более сложному анализу по сути вопроса. Кроме того, мы будем уверены, что экспериментальные условия были должным образом соблюдены, ученые не запутались в кодировании данных и документировали результаты корректно.

Интересующие нас переменные:

LogDurationW - log-transformed word duration (логарифм длины произнесения слова)
LogDurationA - log-transformed segment duration (логарифм длины произнесения сегмента)
Cond - condition: slow vs. fast (условие).

Ссылка на данные [link](https://raw.githubusercontent.com/LingData2019/LingData2020/master/data/dur_word_frequency.csv)

### 1.0 t-test

С помощью t-критерия Стьюдента мы хотим определить статистическую значимость различия значений применительно к следующим переменным:  

(a) word durarion in fast condition and word duration in slow condition,

(b) segment duration in fast condition and segment duration in slow condition. 

Другими словами, мы хотим проверить, что различие этих длительностей имеет место не только на выборках, но и в генеральной совокупности.

#### 1.1 Гипотезы 

В первую очередь, сформулируйте нулевую гипотезу (H_0) и альтернативную гипотезу (H_1). Если для выполнения задания нужно сформулировать несколько H_0 и H_1, сделайте это, продублировав этот и следующий разделы (1.1а, 1.2a, 1.3.a, 1.1b, 1.2b и т.д.)  

```{r libs}
library(tidyverse)
```

```
H0: Mean(Word_duration_slow) = Mean(Word_duration_fast)

H1: Mean(Word_duration_slow) != Mean(Word_duration_fast)
```
```{r load data}
dur_word_freq<-read.csv('https://raw.githubusercontent.com/LingData2019/LingData2020/master/data/dur_word_frequency.csv')
```
#### 1.2 Тест  

Загрузите данные и примените `t.test` для проверки гипотез.  

```{r t-test}
x <- filter(dur_word_freq, Cond == "fast")$LogDurationW
y <- filter(dur_word_freq, Cond == "slow")$LogDurationW
t.test(x, y)
```

```
H0: Mean(Segment_duration_slow) = Mean(Segment_duration_fast)

H1: Mean(Segment_duration_slow) != Mean(Segment_duration_fast)
```

#### 1.2 Тест  

Загрузите данные и примените `t.test` для проверки гипотез.  

```{r t-test}
x <- filter(dur_word_freq, Cond == "fast")$LogDurationA
y <- filter(dur_word_freq, Cond == "slow")$LogDurationA
t.test(x, y)
```

#### 1.3 Интерпретация  

Интерпретируйте результаты t-теста. Включите в вывод t-статистику, степени свободы и p-values. Можно ли заключить, что имеется различие в длительности слов в быстрых и медленных условиях в генеральной совокупности? Можно ли заключить то же самое в отношении длительности сегментов?  

```
В обоих случаях p-value было на порядки ниже 5%, а доверительный интервал не включал 0, что позволяет в обоих случаях отвергнуть нулевую гипотезу и принять альтернативные гипотезы (средние длительности сегментов и слов различны в генеральной совокупности)

```

### 2. Дискуссия 

Возможно, применение t-test в чистом виде является не лучшей опцией для решения задачи 1.0. Если вам тоже так кажется, приведите аргументы против его использования и предложите другое решение. 

```
Проведение теста Шапиро-Уилка показало, что распределения длительностей в трех из 4 случаях нельзя считать близким к нормальному, и поэтому лучше применить непараметрический тест Манна-Уитни. Результаты такие же, как и у t-тестов

```

#### 2.1 Код для решения    

Напишите код, который может помочь в аргументации и покажет другое решение. 

```{r}
shapiro.test(filter(dur_word_freq, Cond == "fast")$LogDurationW)
shapiro.test(filter(dur_word_freq, Cond == "slow")$LogDurationW)
shapiro.test(filter(dur_word_freq, Cond == "fast")$LogDurationA)
shapiro.test(filter(dur_word_freq, Cond == "slow")$LogDurationA)

x <- filter(dur_word_freq, Cond == "fast")$LogDurationW
y <- filter(dur_word_freq, Cond == "slow")$LogDurationW
wilcox.test(x, y)

x <- filter(dur_word_freq, Cond == "fast")$LogDurationA
y <- filter(dur_word_freq, Cond == "slow")$LogDurationA
wilcox.test(x, y)
```


### 3. Доверительный интервал

#### 3.1 Формула в явном виде 

Ниже приведена формула для вычисления 95% доверительного интервала:

$$
\mathrm{CI} = \left[\bar{x} - 1.96\times \frac{\mathop{\mathrm{sd}}(x)}{\sqrt{n}},\ \bar{x} + 1.96\times \frac{\mathop{\mathrm{sd}}(x)}{\sqrt{n}}\right].
$$
Используйте ее для нахождения 95% доверительного интервала для популяционной средней длительности слова (средней в генеральной совокупности).  


```{r ci-formula}
x <- dur_word_freq$LogDurationW
cil <- mean(x) - 1.96*(sd(x)/sqrt(length((x))))
cir <- mean(x) + 1.96*(sd(x)/sqrt(length((x))))
c(cil, cir)
```


#### 3.2 Функция `t.test`

Примените функцию `t.test` к той же переменной, чтобы узнать доверительный интервал среднего. 

```{r ci-ttest}
t.test(x)
```

Совпадают ли результаты вычислений в 2.1 и 2.2?
```
с поправкой на точность порогового значения (1.96).
```

#### 3.3 Другие уровни доверия  

С помощью функции `MeanCI` из пакета `DescTools` найдите 99% доверительный интервал для той же переменнной. Он шире или уже, чем 95% CI?  

Подсказка: используйте аргумент `conf.level`. 

```{r ci-99}
library(DescTools)
DescTools::MeanCI(x, conf.level = 0.99)
```
```
Шире
```

## 4. В каком возрасте дети усваивают слова? 

#### Практика в Tydyverse

Data: https://www.kaggle.com/rtatman/when-do-children-learn-words?select=main_data.csv

Основная таблица включает информацию о 732 словах норвежского языка и возрасте их усвоения детьми (age of acquisition). Другая таблица включает дополнительную информацию о частотности слов по данным веб-корпуса (Norwegian Web as Corpus) и данным разговоров взрослых с детьми.

Релевантные переменные (main data):

**Translation**: английский перевод норвежского слова

**AoA**: возраст усвоения в месяцах (в среднем, в каком возрасте слово усваивается детьми)

**VSoA**: сколько других слов знает "обобщенный" ребенок к моменту усвоения данного слова (округленно к ближайшему десятку)

**Broad_lex**: часть речи данного слова (в широком понимании) 

**CDS_Freq**: частота, с которой взрослый-носитель норвежского языка обращается к ребенку

Релевантные переменные (Norwegian CDS Frequency):

**Translation**: английский перевод норвежского слова

**Freq_NoWaC**: частота по данным корпуса NoWaC (интернет-коммуникация)

**Freq_CDS**: частота слова (по материалам двух норвежских корпусов CHILDES) при обращении к ребенку

NB! Все остальные переменные должны быть удалены из данных.  

NB! Столбцы 'Freq_CDS' and 'CDS_Freq' - это одно и то же. 

#### Данные 

#### 4.1 
Прочитайте обе таблицы   

```{r}
main <- as_tibble(read_csv("main_data.csv"))
freq <- as_tibble(read_csv("Norwegian_CDS_frequency.csv"))
```

#### 4.2 
Оставьте только необходимые для последующего исследования переменные.

```{r}
main <- main[,c("Translation", "AoA", "VSoA", "Broad_lex", "CDS_freq")]
freq <- freq[,c("Translation", "Freq_NoWaC", "Freq_CDS")]
```

#### 4.3  
Объедините две таблицы в общий датафрейм/тиббл под названием 'norw_words'. 

NB! В вашем датафрейме не должно быть дублирования столбцов. 


```{r}
main %>%  cbind(freq) %>% select(!c("Translation","CDS_freq")) -> norw_words

```

#### 4.4  
Оставьте только 15 первых строк 
 
```{r}
short_norw_words <- head(norw_words,15)
short_norw_words
```


#### 5. Преобразования данных 

#### 5.1  
Создайте тиббл 'freq_statistics', используя 3 столбца из (полного) тиббла `norw_words`: 'Translation', 'CDS_Freq', 'Freq_NoWaC'. Затем с помощью функций `pivot_longer`/`pivot_wider` измените формат тиббла с "широкого" на "узкий" или наоборот (данные подскажут вам, с какого на какой менять).

```{r}
norw_words %>% select(Translation, Freq_CDS, Freq_NoWaC) -> freq_statistics
freq_statistics %>% 
  pivot_longer(!Translation, names_to = "stat", values_to = "count")
```

#### 5.2  
Получите строковый вектор (string vector output) с информацией о классах переменных в тиббле. 

```{r}
as_vector(sapply(freq_statistics, class))
```

#### 5.3  
Представьте ту же информацию как датафрейм (dataframe). 

```{r}
as_data_frame(sapply(freq_statistics, class))
```

#### 5.4  
Конвертируйте значения из столбцов `CDS_Freq` и `Freq_NoWaC` тиббла `freq_statistics` в числовые (numeric). 

```{r}
t_n = c("Freq_CDS", "Freq_NoWaC")
freq_statistics[t_n] <- sapply(freq_statistics[t_n], as.numeric)
```

#### 5.5 
Получите средние значения всех числовых типов переменных в `norw_words`.

```{r}
t_n = c("Freq_CDS", "Freq_NoWaC", "AoA", "VSoA")
norw_words[t_n] <- sapply(norw_words[t_n], as.numeric)
colMeans(norw_words[sapply(norw_words, is.numeric)], na.rm=TRUE)
```
#### 5.6 
Создайте вложенную структуру (nested table) по столбцу `Translation`.
 
```{r}
norw_words %>% group_by(Translation) %>% nest()
```

#### 6.1 Корреляционный анализ  

Из доступных данных, выберите несколько переменных (более двух) для проведения корреляционного анализа, визуализируйте тепловую карту или другой тип коррелограммы. 
```{r}
library(Hmisc)
library(corrgram)
```

```{r}
vars <- c("Freq_CDS", "Freq_NoWaC", "AoA", "VSoA")
corrgram(norw_words[, vars])
rcorr(as.matrix(norw_words[, vars]))
```

#### 6.2 
Выводы  

В поле ниже сформулируйте ваши выводы, приведите p-values и другие необходимые статистические метрики. 

```
Величины, которые ожидаемо должны коррелировать: (Два вида частот) и (возраст усвоения и словарный запас к этому времени), ожидаемо и значимо коррелируют. Из более интересных корреляций, значимая (p-value = 0.03 и 0.006), хоть и слабая, положительная зависимость есть между частотой в общем корпусе коммуникации и возрастом усвоения со словарным запасом, (и это контринтуитивно, так как более частые слова должны, по идее, усваиваться раньше). С другой стороны, с частотой употребления слова взрослым у возраста усвоения корреляция с правильным знаком, но значимость недостаточна для отвержения нулевой гипотезы об отсутствии корреляции

```